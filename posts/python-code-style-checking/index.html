<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Python代码风格检查最佳实践 | Jan's Blog</title><meta name=keywords content><meta name=description content="本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。 1. 项目需要统一的代码风格 代码风格类似文章的排版"><meta name=author content="Zhen Zhijian"><link rel=canonical href=https://jan365.org/posts/python-code-style-checking/><link crossorigin=anonymous href=/assets/css/stylesheet.c497b7a7cbdca85553f94851c1c75c9bdb9f591fb1d632a468606eb623c5db7a.css integrity="sha256-xJe3p8vcqFVT+UhRwcdcm9ufWR+x1jKkaGButiPF23o=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jan365.org/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jan365.org/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jan365.org/favicon-32x32.png><link rel=apple-touch-icon href=https://jan365.org/apple-touch-icon.png><link rel=mask-icon href=https://jan365.org/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-47790058-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Python代码风格检查最佳实践"><meta property="og:description" content="本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。 1. 项目需要统一的代码风格 代码风格类似文章的排版"><meta property="og:type" content="article"><meta property="og:url" content="https://jan365.org/posts/python-code-style-checking/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-02-04T18:20:52+08:00"><meta property="article:modified_time" content="2020-02-04T18:20:52+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python代码风格检查最佳实践"><meta name=twitter:description content="本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。 1. 项目需要统一的代码风格 代码风格类似文章的排版"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://jan365.org/posts/"},{"@type":"ListItem","position":2,"name":"Python代码风格检查最佳实践","item":"https://jan365.org/posts/python-code-style-checking/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Python代码风格检查最佳实践","name":"Python代码风格检查最佳实践","description":"本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。 1. 项目需要统一的代码风格 代码风格类似文章的排版","keywords":[],"articleBody":"本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。\n1. 项目需要统一的代码风格 代码风格类似文章的排版要求，一本杂志、书籍往往由多人合著，作者们需要达成共识用统一的排版风格。程序同样由多个程序员合作编写而成，甚至还会互相修改其他成员的代码，统一的风格犹为重要。\n2. Python 项目的代码风格 Python 项目的代码风格，我认为需要分成两层：\nPEP 8，这是 Python 社区的共识，应该作为我们项目代码风格的底线。然而，PEP 8 的规定相当宽泛，符合 PEP 8的前提下，仍然可以写出风格迥异代码。因此，项目通常又会在 PEP 8的基础上制定 项目风格要求。在PEP 8基础上制定项目风格，实际上是基于一些的原因增加限制。比如规定字典元素太多时该如何换行。风格一，尽量在一行写入最多的元素，原因是这样能使代码更紧凑。 {'key1': 'value1', 'key2': 'value2', 'key3': 'value3', 'key4': 'value4', 'key5': 'value5', 'key6': 'value6'} 风格二，一行一个元素，原因是将来增删改元素只会影响到一行，方便 diff review。\n{ 'key1': 'value1', 'key2': 'value2', 'key3': 'value3', 'key4': 'value4', } 都有道理，需要项目成员达成共识，制定出项目的风格要求。\n3. 代码风格检查 代码风格制定好了，如果没有相应检查机制，我相信制定好的代码风格并不会得到完整的执行。 如何检查 Python 代码风格是本文重点。我把代码风格检查机制按照自动化程度分成以下层次：\n人工检查； 手动运行检查器； 自动运行检查器； 自动修正代码风格； 3.1. 人工检查 人工检查是最原始的，在 code review 的时候，看看是不是有代码风格问题。熟悉 PEP 8的 Python 程序员应该具备肉眼检查 PEP 8风格的能力，通常风格问题是很碍眼的，想看不出来都难。 然而人工检查存在着明显的问题：\ncode review 还要把精力放在代码风格上； code review 阶段还要提一批风格相关的 issues； code review 阶段还得来回修改代码风格问题； 人毕竟不是机器，可能有遗漏。 缺点： 显然，人工检查存在效率和严谨性的问题，更何况有些项目并没有对每一个 commit 做 code review，人工检查得等到什么时候触碰到这些代码时才能进行。\n3.2. 手动运行检查器 代码风格检查工作如此的机械化，显然适合让机器做，而不必浪费程序员的精力。\n常用的检查器有：pep8 · PyPI、flake8、pylint。推荐 flake8，其结合 pep8 和其他一些风格检查，基本上忠实于 pep8，不会带来太多打扰。不推荐 pylint 是因为 pylint 的默认配置非常糟糕（不是 PEP 8，也不是哪个社区的共识），非开箱即用，得根据项目代码风格精心配置，否则相当打扰。不过 flake8 的可定制性较差，额外的项目风格无法检测，pylint 相对来说可定制性更高。\n有了检查器，程序员可以在提交代码前运行检查，根检查器报告修改，直到完全通过。进阶一点可以用相应的编辑器插件，边写边检查。\n缺点： 手动运行的问题是，程序员可能忘记运行了，或者新加入项目的程序员根本不知道有这个规则。\n那么我们自然会想到自动运行检查器。\n3.3. 自动运行检查器 自动运行检查器有这些方案：\nGit Hooks，git hooks 又分为 客户端 hooks， 服务端 hooks； CI 持续集成。 这些方案中我推荐客户端 Git Hooks。 相对服务端 hooks，客户端 hooks 不需要服务端支持，适应性高；相对于 CI，搭建成本低，且在代码提交前就检查好风格，而不是到了集成阶段再来检查。\n客户端 hooks 的原理非常简单，.git/hooks 目录下有很多 .sample 文件，是各个阶段 hook 的例子。\n$ ls .git/hooks/ applypatch-msg.sample\tpre-applypatch.sample pre-receive.sample commit-msg.sample\tpre-commit.sample\tprepare-commit-msg.sample fsmonitor-watchman.sample pre-push.sample\tupdate.sample post-update.sample\tpre-rebase.sample 这里我们需要 pre-commit hook，创建一个 pre-commit 文件，内容是 shell 脚本，运行检查器。如果检查不通过就会阻止 commit。通过这样的机制就能确保检查器运行且检查通过。\n然而，客户端的 hooks 是在本地的，不在仓库里管理，也就是说 hooks 不能共享不能同步。为了解决这个问题，又有了 pre-commit 这个工具，只需要在仓库根目录放置一个 .pre-commit-config.yaml ，定义需要的 hooks（github 上很多开源的 hook 可以在这里直接引用，当然也包括 flake8），把这个文件提交到仓库。然后在客户端运行一次 pre-commit install --install-hooks 即可注册到 .git/hooks/pre-commit 里，后继 .pre-commit-config.yaml 更新也同步到各个客户端。用法详见第4节。\n到目前为止，已经做到确保代码在提交到仓库之前是通过代码风格检查的。\n缺点： 要说还有什么不足，那就是检查虽然是自动，但修正还得手动。那么有没有自动修正的方案？\n3.4. 自动修正代码风格 Python 代码风格自动修正，目前最好的应该是 Black。Black 是 PSF（Python Software Foundation，Python 软件基金会）的项目。为什么要强调是 PSF 的项目？因为符合 PEP 8的写法可以有很多种，而修正工具只能修正成其中一种。 那么哪一种写法才大家都喜欢的？这就需要项目成员达成共识，也就是第2节提到的项目的风格要求。而 Black 作为 PSF 的项目，一定程度上代表了 Python 社区的共识。 那么，我们没必要再花精力制定项目代码风格，直接交给 Black 就好了。\nBlack 在文档详细介绍了其代码风格及相应的原因，比如为什么默认一行的长度限制是88字符（可以配置），比 PEP 8标准增加10%，有兴趣可以看一下。\n同样，把 Black 也加到 pre-commit hook 里，那么在提交代码的时候就会自动修正代码风格。再加一道风格检查，把不能自动修正的提示出来，让提交者手动修正。\n这样就形成了本文的最佳实践，具体做法见下一节。\n4. 最佳实践 在仓库根目录放置以下3个文件，并提交。执行一次 make init 即完成所有配置工作。\n实现的功能有：在 commit 的时候，\n自动重排 import 顺序， 修正代码风格， 检查代码风格， 修正其他文件格式问题。 .flake8\n[flake8] max-line-length = 80 select = C,E,F,W,B,B950 ignore = E203,E501,W503 .pre-commit-config.yaml：\nrepos: - repo: https://github.com/asottile/reorder_python_imports rev: v1.8.0 hooks: - id: reorder-python-imports name: Reorder Python imports (src, tests) - repo: https://github.com/python/black rev: stable hooks: - id: black - repo: https://gitlab.com/pycqa/flake8 rev: 3.7.9 hooks: - id: flake8 additional_dependencies: [flake8-bugbear] - repo: https://github.com/pre-commit/pre-commit-hooks rev: v2.4.0 hooks: - id: check-byte-order-marker - id: trailing-whitespace - id: end-of-file-fixer Makefile:\ninit: python3 -m venv .venv .venv/bin/pip install pre-commit .venv/bin/pre-commit install --install-hooks clean: rm -rf .venv .PHONY: init clean 该方案受 Flask 的 contributing guidelines 启发。\n","wordCount":"2224","inLanguage":"en","datePublished":"2020-02-04T18:20:52+08:00","dateModified":"2020-02-04T18:20:52+08:00","author":{"@type":"Person","name":"Zhen Zhijian"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jan365.org/posts/python-code-style-checking/"},"publisher":{"@type":"Organization","name":"Jan's Blog","logo":{"@type":"ImageObject","url":"https://jan365.org/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jan365.org/ accesskey=h title="Jan's Blog (Alt + H)">Jan's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jan365.org/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://jan365.org/categories/ title=Categories><span>Categories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://jan365.org/>Home</a>&nbsp;»&nbsp;<a href=https://jan365.org/posts/>Posts</a></div><h1 class=post-title>Python代码风格检查最佳实践</h1><div class=post-meta><span title='2020-02-04 18:20:52 +0800 +0800'>February 4, 2020</span>&nbsp;·&nbsp;Zhen Zhijian</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#1-%e9%a1%b9%e7%9b%ae%e9%9c%80%e8%a6%81%e7%bb%9f%e4%b8%80%e7%9a%84%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc aria-label="1. 项目需要统一的代码风格">1. 项目需要统一的代码风格</a></li><li><a href=#2-python-%e9%a1%b9%e7%9b%ae%e7%9a%84%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc aria-label="2. Python 项目的代码风格">2. Python 项目的代码风格</a></li><li><a href=#3-%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc%e6%a3%80%e6%9f%a5 aria-label="3. 代码风格检查">3. 代码风格检查</a><ul><li><a href=#31-%e4%ba%ba%e5%b7%a5%e6%a3%80%e6%9f%a5 aria-label="3.1. 人工检查">3.1. 人工检查</a></li><li><a href=#32-%e6%89%8b%e5%8a%a8%e8%bf%90%e8%a1%8c%e6%a3%80%e6%9f%a5%e5%99%a8 aria-label="3.2. 手动运行检查器">3.2. 手动运行检查器</a></li><li><a href=#33-%e8%87%aa%e5%8a%a8%e8%bf%90%e8%a1%8c%e6%a3%80%e6%9f%a5%e5%99%a8 aria-label="3.3. 自动运行检查器">3.3. 自动运行检查器</a></li><li><a href=#34-%e8%87%aa%e5%8a%a8%e4%bf%ae%e6%ad%a3%e4%bb%a3%e7%a0%81%e9%a3%8e%e6%a0%bc aria-label="3.4. 自动修正代码风格">3.4. 自动修正代码风格</a></li></ul></li><li><a href=#4-%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5 aria-label="4. 最佳实践">4. 最佳实践</a></li></ul></div></details></div><div class=post-content><p>本文介绍 Python 代码风格检查的实践，其中第3节渐进式介绍了4种方案，也可以直接看第4节“最佳实践”。</p><h2 id=1-项目需要统一的代码风格>1. 项目需要统一的代码风格<a hidden class=anchor aria-hidden=true href=#1-项目需要统一的代码风格>#</a></h2><p>代码风格类似文章的排版要求，一本杂志、书籍往往由多人合著，作者们需要达成共识用统一的排版风格。程序同样由多个程序员合作编写而成，甚至还会互相修改其他成员的代码，统一的风格犹为重要。</p><h2 id=2-python-项目的代码风格>2. Python 项目的代码风格<a hidden class=anchor aria-hidden=true href=#2-python-项目的代码风格>#</a></h2><p>Python 项目的代码风格，我认为需要分成两层：</p><ol><li><a href=https://www.python.org/dev/peps/pep-0008/>PEP 8</a>，这是 Python 社区的共识，应该作为我们项目代码风格的底线。然而，PEP 8 的规定相当宽泛，符合 PEP 8的前提下，仍然可以写出风格迥异代码。因此，项目通常又会在 PEP 8的基础上制定</li><li>项目风格要求。在PEP 8基础上制定项目风格，实际上是基于一些的原因增加限制。比如规定字典元素太多时该如何换行。风格一，尽量在一行写入最多的元素，原因是这样能使代码更紧凑。</li></ol><pre tabindex=0><code>{&#39;key1&#39;: &#39;value1&#39;, &#39;key2&#39;: &#39;value2&#39;, &#39;key3&#39;: &#39;value3&#39;, &#39;key4&#39;: &#39;value4&#39;,
 &#39;key5&#39;: &#39;value5&#39;, &#39;key6&#39;: &#39;value6&#39;}
</code></pre><p>风格二，一行一个元素，原因是将来增删改元素只会影响到一行，方便 diff review。</p><pre tabindex=0><code>{
    &#39;key1&#39;: &#39;value1&#39;,
    &#39;key2&#39;: &#39;value2&#39;,
    &#39;key3&#39;: &#39;value3&#39;,
    &#39;key4&#39;: &#39;value4&#39;,
}
</code></pre><p>都有道理，需要项目成员达成共识，制定出项目的风格要求。</p><h2 id=3-代码风格检查>3. 代码风格检查<a hidden class=anchor aria-hidden=true href=#3-代码风格检查>#</a></h2><p>代码风格制定好了，<strong>如果没有相应检查机制，我相信制定好的代码风格并不会得到完整的执行。</strong> 如何检查 Python 代码风格是本文重点。我把代码风格检查机制按照自动化程度分成以下层次：</p><ol><li>人工检查；</li><li>手动运行检查器；</li><li>自动运行检查器；</li><li>自动修正代码风格；</li></ol><h3 id=31-人工检查>3.1. 人工检查<a hidden class=anchor aria-hidden=true href=#31-人工检查>#</a></h3><p>人工检查是最原始的，在 code review 的时候，看看是不是有代码风格问题。熟悉 PEP 8的 Python 程序员应该具备肉眼检查 PEP 8风格的能力，通常风格问题是很碍眼的，想看不出来都难。
然而人工检查存在着明显的问题：</p><ol><li>code review 还要把精力放在代码风格上；</li><li>code review 阶段还要提一批风格相关的 issues；</li><li>code review 阶段还得来回修改代码风格问题；</li><li>人毕竟不是机器，可能有遗漏。</li></ol><p><strong>缺点：</strong> 显然，人工检查存在效率和严谨性的问题，更何况有些项目并没有对每一个 commit 做 code review，人工检查得等到什么时候触碰到这些代码时才能进行。</p><h3 id=32-手动运行检查器>3.2. 手动运行检查器<a hidden class=anchor aria-hidden=true href=#32-手动运行检查器>#</a></h3><p>代码风格检查工作如此的机械化，显然适合让机器做，而不必浪费程序员的精力。</p><p>常用的检查器有：<a href=https://pypi.org/project/pep8/>pep8 · PyPI</a>、<a href=https://flake8.pycqa.org/en/latest/>flake8</a>、<a href=https://flake8.pycqa.org/en/latest/>pylint</a>。推荐 flake8，其结合 pep8 和其他一些风格检查，基本上忠实于 pep8，不会带来太多打扰。不推荐 pylint 是因为 pylint 的默认配置非常糟糕（不是 PEP 8，也不是哪个社区的共识），非开箱即用，得根据项目代码风格精心配置，否则相当打扰。不过 flake8 的可定制性较差，额外的项目风格无法检测，pylint 相对来说可定制性更高。</p><p>有了检查器，程序员可以在提交代码前运行检查，根检查器报告修改，直到完全通过。进阶一点可以用相应的编辑器插件，边写边检查。</p><p><strong>缺点：</strong> 手动运行的问题是，程序员可能忘记运行了，或者新加入项目的程序员根本不知道有这个规则。</p><p>那么我们自然会想到自动运行检查器。</p><h3 id=33-自动运行检查器>3.3. 自动运行检查器<a hidden class=anchor aria-hidden=true href=#33-自动运行检查器>#</a></h3><p>自动运行检查器有这些方案：</p><ol><li><a href=https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks>Git Hooks</a>，git hooks 又分为<ol><li>客户端 hooks，</li><li>服务端 hooks；</li></ol></li><li><a href=https://en.wikipedia.org/wiki/Continuous_integration>CI</a> 持续集成。</li></ol><p><strong>这些方案中我推荐客户端 Git Hooks。</strong> 相对服务端 hooks，客户端 hooks 不需要服务端支持，适应性高；相对于 CI，搭建成本低，且在代码提交前就检查好风格，而不是到了集成阶段再来检查。</p><p>客户端 hooks 的原理非常简单，.git/hooks 目录下有很多 .sample 文件，是各个阶段 hook 的例子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ ls .git/hooks/
</span></span><span style=display:flex><span>applypatch-msg.sample	   pre-applypatch.sample  pre-receive.sample
</span></span><span style=display:flex><span>commit-msg.sample	   pre-commit.sample	  prepare-commit-msg.sample
</span></span><span style=display:flex><span>fsmonitor-watchman.sample  pre-push.sample	  update.sample
</span></span><span style=display:flex><span>post-update.sample	   pre-rebase.sample
</span></span></code></pre></div><p>这里我们需要 pre-commit hook，创建一个 pre-commit 文件，内容是 shell 脚本，运行检查器。如果检查不通过就会阻止 commit。通过这样的机制就能确保检查器运行且检查通过。</p><p>然而，客户端的 hooks 是在本地的，不在仓库里管理，也就是说 hooks 不能共享不能同步。为了解决这个问题，又有了 <a href=https://pre-commit.com/>pre-commit</a> 这个工具，只需要在仓库根目录放置一个 .pre-commit-config.yaml ，定义需要的 hooks（github 上很多开源的 hook 可以在这里直接引用，当然也包括 flake8），把这个文件提交到仓库。然后在客户端运行一次 <code>pre-commit install --install-hooks</code> 即可注册到 .git/hooks/pre-commit 里，后继 .pre-commit-config.yaml 更新也同步到各个客户端。用法详见第4节。</p><p>到目前为止，已经做到确保代码在提交到仓库之前是通过代码风格检查的。</p><p><strong>缺点：</strong> 要说还有什么不足，那就是检查虽然是自动，但修正还得手动。那么有没有自动修正的方案？</p><h3 id=34-自动修正代码风格>3.4. 自动修正代码风格<a hidden class=anchor aria-hidden=true href=#34-自动修正代码风格>#</a></h3><p>Python 代码风格自动修正，目前最好的应该是 <a href=https://black.readthedocs.io/en/stable/>Black</a>。Black 是 PSF（Python Software Foundation，Python 软件基金会）的项目。为什么要强调是 PSF 的项目？<strong>因为符合 PEP 8的写法可以有很多种，而修正工具只能修正成其中一种。</strong> 那么哪一种写法才大家都喜欢的？这就需要项目成员达成共识，也就是第2节提到的项目的风格要求。<strong>而 Black 作为 PSF 的项目，一定程度上代表了 Python 社区的共识。</strong> 那么，我们没必要再花精力制定项目代码风格，直接交给 Black 就好了。</p><p>Black 在<a href=https://black.readthedocs.io/en/stable/the_black_code_style.html>文档</a>详细介绍了其代码风格及相应的原因，比如为什么默认一行的长度限制是88字符（可以配置），比 PEP 8标准增加10%，有兴趣可以看一下。</p><p>同样，把 Black 也加到 pre-commit hook 里，那么在提交代码的时候就会自动修正代码风格。再加一道风格检查，把不能自动修正的提示出来，让提交者手动修正。</p><p>这样就形成了本文的最佳实践，具体做法见下一节。</p><h2 id=4-最佳实践>4. 最佳实践<a hidden class=anchor aria-hidden=true href=#4-最佳实践>#</a></h2><p>在仓库根目录放置以下3个文件，并提交。执行一次 <code>make init</code> 即完成所有配置工作。</p><p>实现的功能有：在 commit 的时候，</p><ol><li>自动重排 import 顺序，</li><li>修正代码风格，</li><li>检查代码风格，</li><li>修正其他文件格式问题。</li></ol><p>.flake8</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff79c6>[flake8]</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>max-line-length</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>80</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>select</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>C,E,F,W,B,B950</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>ignore</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>E203,E501,W503</span>
</span></span></code></pre></div><p>.pre-commit-config.yaml：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>repos</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>repo</span>: https://github.com/asottile/reorder_python_imports
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rev</span>: v1.8.0
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hooks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: reorder-python-imports
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>name</span>: Reorder Python imports (src, tests)
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>repo</span>: https://github.com/python/black
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rev</span>: stable
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hooks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: black
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>repo</span>: https://gitlab.com/pycqa/flake8
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rev</span>: <span style=color:#bd93f9>3.7.9</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hooks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: flake8
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>additional_dependencies</span>: [flake8-bugbear]
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>repo</span>: https://github.com/pre-commit/pre-commit-hooks
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rev</span>: v2.4.0
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>hooks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: check-byte-order-marker
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: trailing-whitespace
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>id</span>: end-of-file-fixer
</span></span></code></pre></div><p>Makefile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#50fa7b>init</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>	python3 -m venv .venv
</span></span><span style=display:flex><span>	.venv/bin/pip install pre-commit
</span></span><span style=display:flex><span>	.venv/bin/pre-commit install --install-hooks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>clean</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>	rm -rf .venv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>.PHONY</span><span style=color:#ff79c6>:</span> init clean
</span></span></code></pre></div><p>该方案受 <a href=https://github.com/pallets/flask/blob/master/CONTRIBUTING.rst>Flask 的 contributing guidelines</a> 启发。</p></div><footer class=post-footer><ul class=post-tags></ul></footer><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//blog-ywllbb4f2v.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2022 <a href=https://jan365.org/>Jan's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>